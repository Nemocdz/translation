title: "UTF-8 字符串"
date: 
tags: [Swift,iOS]
categories: [swift.org]
permalink: utf8-string
keywords: swift,utf8,string
custom_title: "UTF-8 字符串"

------

原文链接=https://swift.org/blog/utf8-string/
作者=Michael Ilseman
原文日期=2019-03-20
译者=Nemocdz
校对=
定稿=

<!--此处开始正文-->

Swift 5 把字符串首选编码从 UTF-16 切换到 UTF-8 后，还保持着良好的 Objective-C 兼容性。这是因为 String 类型对此做了抽象，将问题隐藏在更底层了。开发者虽然无需改动任何源码*，但这个举动给现在和以后带来的收益是值得一提的。

<!--more-->

切换到 UTF-8 完成了 String 实现 [高性能处理](https://github.com/apple/swift/blob/master/docs/StringManifesto.md#high-performance-string-processing) 这个长期目标，这是性能敏感型开发者 [最关心的](https://bugs.swift.org/browse/SR-7602)。这也为以后提供更多高性能 API 奠定了基础。String 的首选编码因性能原因是需要合入 Swift ABI 的，所以需要及时进行该切换以确保 Swift 5 的 ABI 稳定性。

_* 查看下面的 “*[ 使用 `String.Index.encodedOffset` 的危害](https://swift.org/blog/utf8-string/#use-of-stringindexencodedoffset-considered-harmful)*” 来了解滥用所造成的潜在表现变化_

## 原理

### 结构的变化

尽管 String 类型从代码上看是一个结构体，但它可以以很多种形式存在。你可以把 String 想象成一个_手工制作的枚举_，手动使用传统的 [位操作（bit-twiddling）](https://en.wikipedia.org/wiki/Bit_manipulation) 技术生产而来 [紧凑](https://github.com/apple/swift/blob/19014a85af33bc29c5265a7f427c6d80fd151a1b/stdlib/public/core/StringObject.swift#L55) 且 [高效](https://github.com/apple/swift/blob/19014a85af33bc29c5265a7f427c6d80fd151a1b/stdlib/public/core/StringObject.swift#L294) 的代码。

Swift 5 之前，字符串内容可以使用两种原生存储编码之一：用于 Unicode 富文本的 UTF-16、当内容都是 ASCII 时的 ASCII 专用存储类。在 Swift 5 中，这两种编码都被一种单独的 UTF-8 存储编码取代了。

![String forms](https://swift.org/assets/images/utf8-string-blog/string-forms.png)

